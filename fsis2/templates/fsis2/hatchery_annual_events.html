{% extends "fsis2/fsis2_base.html" %}


{% block extrahead %}

{% load humanize %}
{% load fsis2_filters %}
{% load geojson_tags %}
{% load leaflet_tags %}

{% leaflet_js %}
{% leaflet_css %}


<style>

 td {
     padding: 0px 10px 2px 0px;}

</style>

{% endblock extrahead %}


{% block content %}


<div class="container">

    <h3>Stocking events associated with {{ proponent.proponent_name}} ({{ proponent.abbrev}}) in {{ year}}:</h3>
    <br />

    <div id="maprow" class="row" >
        <div class="col-md-11" >
            <div id="main_map" style="width: 800px; height: 700px;"></div>
        </div>

        <div class="col-md-1" >
            <div class="btn-group-vertical" role="group" aria-label="plotby">
                <button type="button" id="byspecies" class="btn btn-primary">By Species</button>
                <button type="button" id="bystrain" class="btn btn-default">By Strain</button>
                <button type="button" id="byhatchery" class="btn btn-default" >By Hatchery</button>
            </div>
        </div>
    </div>

    <br />

    {% if object_list %}

    {% regroup object_list by lot.species as species_list %}

    <div>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">

            {% for species in species_list %}
            <li role="presentation" {% if forloop.first %}class="active"{% endif %}><a href="#{{ species.grouper|scrub_spc }}" aria-controls="{{ species.grouper|scrub_spc }}" role="tab" data-toggle="tab">{{ species.grouper }} (N={{ species.list|length }})</a></li>

            {% endfor %}
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
            {% for species in species_list %}
            <div role="tabpanel" class="tab-pane {% if forloop.first %}active{% endif %}" id="{{ species.grouper|scrub_spc }}">

                <table id="myTable {{ species.grouper|scrub_spc }}" class="table tablesorter">
                    <thead><tr>
                        <td>FSIS Event</td>
                        <td>Species</td>
                        <td>Strain</td>
                        <td>Number Stocked</td>
                        <td>Event Date</td>
                        <td>Site Name</td>
                        <td>Clip Applied</td>
                        <td>Development Stage</td></tr>
                    </thead>
                    <tbody>
                        {% for event in species.list %}
                        <tr class="{% cycle row1,row2 %}">
                            <td> <a href="{% url 'event_detail'  event.id  %}">{{ event.fs_event }}</a> </td>
                            <td> {{ event.lot.species.common_name | title }} </td>
                            <td> {{ event.lot.strain.strain_name | title }} </td>
                            <td> {{ event.stkcnt|intcomma }} </td>
                            <td> {{ event.event_date|date }} </td>
                            <td> {{ event.site.site_name }} </td>
                            <td> {{ event.clipa }} </td>
                            <td> {{ event.get_development_stage_display }} </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
            {% endfor %}
        </div>
    </div>

    {% else %}

    <h4> {{ proponent.proponent_name}} ({{ proponent.abbrev}}) did not stock any fish in {{ year}}.</h4>

    {% endif %}

</div>


<!-- tablesorter plugin-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.17.7/js/jquery.tablesorter.js"></script>

<!-- tablesorter widget file - loaded after the plugin -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.17.7/js/jquery.tablesorter.widgets.js"></script>


<script type="text/javascript">

 $(document).ready(function(){

     // we will initialize the map over lake huron - this could be customized at some point in the future.
     var  my_map = new L.map('main_map').setView([45,-82], 7);

     var events = {{ object_list|geojsonfeature:"popup_text,spc_code,strain_code,hatchery_code"|safe }};

     function onEachFeature(feature, layer) {
         if (feature.properties && feature.properties.popup_text) {
             layer.bindPopup(feature.properties.popup_text);
         }
     }

     var  byspecies = L.geoJson(events, {
         style: function(feature) {
             switch (feature.properties.spc_code) {
                     //bright pink
                 case 74: return {color: "#FF3399", fillColor:"#FF3399"};
                     // purple - light purple
                 case 75: return {color: "#6600CC", fillColor:"#CC99FF"};
                     // red - yellow fill
                 case 76: return {color: "#FF0000", fillColor:"#FFFF66"};
                     // orange -- orange fill
                 case 78: return {color: "#CC3300", fillColor:"#FF9933"};
                     // green -- dk green
                 case 80: return {color: "#00CC00", fillColor:"#006600"};
                     //green - yellow fill
                 case 81: return {color: "#00CC00", fillColor:"#FFFF66"};
                     // green - light green
                 case 82: return {color: "#00CC00", fillColor:"#CCFFCC"};
                     // green - bright pink
                 case 87: return {color: "#00CC00", fillColor:"#FF66CC"};
                     // red - red fill
                 case 132: return {color: "#FF0000", fillColor:"#FF0000"};
                     // blue - blue fill
                 case 316: return {color: "#0000FF", fillColor:"#0000FF"};
                     // blue -- yellow fill
                 case 334: return {color: "#0000FF", fillColor:"#FFFF00"};
                     // purple - light yellow fill
                 default: return {color: "#6600CC", fillColor:"#FFFF99"};
             }},
         pointToLayer: function(feature, latlng) {
             return new L.CircleMarker(latlng, {radius: 5, fillOpacity: 0.75});
         },
         onEachFeature: onEachFeature})


     var  bystrain = L.geoJson(events, {
         style: function(feature) {
             switch (feature.properties.strain_code) {
                 // these are hardcoded right now, but should be dynamic in the future.
                     //bright pink
                 case "MB": return {color: "#FF3399", fillColor:"#FF3399"};
                     // purple - light purple
                 case "SN": return {color: "#6600CC", fillColor:"#CC99FF"};
                     // red - yellow fill
                 case "ST": return {color: "#FF0000", fillColor:"#FFFF66"};
                     // orange -- orange fill
                 case "BS": return {color: "#CC3300", fillColor:"#FF9933"};
                     // green -- dk green
                 case "LM": return {color: "#00CC00", fillColor:"#006600"};
                     //green - yellow fill
                 case "MP": return {color: "#00CC00", fillColor:"#FFFF66"};
                     // green - light green
                 case "IB": return {color: "#00CC00", fillColor:"#CCFFCC"};
                     // green - bright pink
                 case "DOM": return {color: "#00CC00", fillColor:"#FF66CC"};
                     // red - red fill
                 case "UNKN": return {color: "#FF0000", fillColor:"#FF0000"};
                     // purple - light yellow fill
                 default: return {color: "#6600CC", fillColor:"#FFFF99"};
             }},
         pointToLayer: function(feature, latlng) {
             return new L.CircleMarker(latlng, {radius: 5, fillOpacity: 0.75});
         },
         onEachFeature: onEachFeature})


     var  byhatchery = L.geoJson(events, {
         style: function(feature) {
             switch (feature.properties.hatchery_code) {
                 // these are hardcoded right now, but should be dynamic in the future.
                     //bright pink
                 case "BJC": return {color: "#FF3399", fillColor:"#FF3399"};
                     // purple - light purple
                 case "TTC": return {color: "#6600CC", fillColor:"#CC99FF"};
                     // red - yellow fill
                 case "CWC": return {color: "#FF0000", fillColor:"#FFFF66"};
                     // orange -- orange fill
                 case "LHC": return {color: "#CC3300", fillColor:"#FF9933"};
                     // green -- dk green
                 case "MVA": return {color: "#00CC00", fillColor:"#006600"};
                     //green - yellow fill
                 case "SSA": return {color: "#00CC00", fillColor:"#FFFF66"};
                     // green - light green
                 case "BPA": return {color: "#00CC00", fillColor:"#CCFFCC"};
                     // green - bright pink
                 case "GBC": return {color: "#00CC00", fillColor:"#FF66CC"};
                     // red - red fill
                 case "BFA": return {color: "#FF0000", fillColor:"#FF0000"};
                     // blue - blue fill
                 case "GTAA": return {color: "#0000FF", fillColor:"#0000FF"};
                     // blue -- yellow fill
                 case "TGB": return {color: "#0000FF", fillColor:"#FFFF00"};
                     // purple - light yellow fill
                 default: return {color: "#6600CC", fillColor:"#FFFF99"};
             }},
         pointToLayer: function(feature, latlng) {
             return new L.CircleMarker(latlng, {radius: 5, fillOpacity: 0.75});
         },
         onEachFeature: onEachFeature})

     L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ', {
         maxZoom: 18,
         attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                      '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                      'Imagery  <a href="http://mapbox.com">Mapbox</a>',
         id: 'mapbox.streets'
     }).addTo(my_map);

     byspecies.addTo(my_map);

     // button click events.

     $("#byhatchery").click(function() {
         my_map.removeLayer(byspecies);
         my_map.removeLayer(bystrain);
         my_map.addLayer(byhatchery);

         $("#byhatchery").removeClass("btn-default").addClass("btn-primary");
         $("#byspecies").removeClass("btn-primary").addClass("btn-default");
         $("#bystrain").removeClass("btn-primary").addClass("btn-default");

     });

     $("#byspecies").click(function(){
         my_map.removeLayer(bystrain);
         my_map.removeLayer(byhatchery);
         my_map.addLayer(byspecies);

         $("#byspecies").removeClass("btn-default").addClass("btn-primary");
         $("#bystrain").removeClass("btn-primary").addClass("btn-default");
         $("#byhatchery").removeClass("btn-primary").addClass("btn-default");

     });

     $("#bystrain").on("click", function (e) {
         my_map.removeLayer(byhatchery);
         my_map.removeLayer(byspecies);
         my_map.addLayer(bystrain);

         $("#bystrain").removeClass("btn-default").addClass("btn-primary");
         $("#byspecies").removeClass("btn-primary").addClass("btn-default");
         $("#byhatchery").removeClass("btn-primary").addClass("btn-default");

     });

 });  //end of document ready

//===================================


 $(".tablesorter").tablesorter({
     theme: 'bootstrap',
     widthFixed: true,
     showProcessing: true,
     headerTemplate: '{content} {icon}',
     widgets: ['zebra', 'uitheme', 'scroller'],
     widgetOptions: {
         scroller_height: 300,
         scroller_barWidth: 17,
         scroller_jumpToHeader: true,
         scroller_idPrefix: 's_'
     }
 });

 $('#myTabs a').click(function (e) {
     e.preventDefault()
         $(this).tab('show')
 })



</script>



{% endblock %}
